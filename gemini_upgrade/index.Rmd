---
title: "CHRUST_PLUS"
output: 
  flexdashboard::flex_dashboard:
    theme:
      bg: "#1F968BFF"
      fg: "#FDF7F7" 
      primary: "#440154FF"
      base_font:
        google: Prompt
      code_font:
        google: JetBrains Mono
    orientation: columns
    vertical_layout: fill
---

```{r setup}
library(flexdashboard)
library(plotly)
library(dplyr)
library(shiny)

source("mqtt.R")
source("ml_predict.R")
```

Column {data-width=600 .tabset}
-----------------------------------------------------------------------

### Energia bufora

```{r}
plotly::ggplotly(qp)
```

### Temperatury

```{r}
plotly::ggplotly(plot_temp, dynamicTicks = TRUE) %>%
  layout(legend = list(orientation = 'h'))
```


Column {data-width=400 .tabset}
-----------------------------------------------------------------------

### Profil temperatur bufora

```{r}
plotly::ggplotly(plot_buffer, dynamicTicks = TRUE) %>%
  layout(legend = list(orientation = 'h'))
```

### Krzywa grzewcza

```{r}
plotly::ggplotly(krzywe)
```

Column {data-width=300}
-----------------------------------------------------------------------

### Predykcja

```{r}
numericInput("wood_amount", "Ilość drewna (kg):", 1, min = 1, max = 100)
actionButton("predict_button", "Predykcja")
```

```{r}
# Reactive plot for prediction
renderPlotly({
  event_data("plotly_click", source = "predict_button")
  
  # Get the latest data point
  latest_data <- dt[nrow(dt), ]
  
  # Simulate the effect of adding wood
  wood_energy <- input$wood_amount * 4 # 1 kg = 4 kWh
  latest_data$Q_buf <- latest_data$Q_buf + wood_energy
  
  # Predict the future
  future_q_buf <- predict_q_buf_delta(latest_data)
  time_to_discharge <- predict_time_to_discharge(latest_data)
  time_extended <- predict_time_extended(latest_data)
  
  # Create a data frame for the prediction plot
  prediction_df <- tibble(
    time = seq(from = Sys.time(), by = "hour", length.out = 24),
    predicted_q_buf = latest_data$Q_buf + cumsum(rep(future_q_buf, 24))
  )
  
  # Create the plot
  plot_ly(prediction_df, x = ~time, y = ~predicted_q_buf, type = 'scatter', mode = 'lines', name = 'Przewidywana energia bufora') %>%
    layout(title = "Predykcja energii bufora",
           yaxis = list(title = "Energia bufora [kWh]"))
})

# Display the predictions
renderText({
  paste("Przewidywany czas do rozładowania:", round(time_to_discharge, 2), "godz.")
})

renderText({
  paste("Przewidywany czas podtrzymania:", round(time_extended, 2), "godz.")
})
```
